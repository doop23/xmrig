name: Windows x64 (MSYS2 UCRT)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSYS2 (UCRT64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >
            git
            base-devel
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-libuv
            mingw-w64-ucrt-x86_64-hwloc
            mingw-w64-ucrt-x86_64-openssl
            mingw-w64-ucrt-x86_64-nsis

      - name: Fetch upstream tags
        run: |
          git fetch --tags https://github.com/xmrig/xmrig.git

      - name: Checkout latest upstream release
        run: |
          LATEST_TAG=$(git tag | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          echo "Building $LATEST_TAG"
          git checkout "$LATEST_TAG"

      - name: Apply patch branch
        run: |
          git fetch origin patch
          git merge --no-ff origin/patch

      - name: Configure (CMake)
        run: |
          mkdir build
          cd build

          cmake .. \
            -G "MinGW Makefiles" \
            -DBUILD_STATIC=ON \
            -DWITH_EMBEDDED_CONFIG=ON \
            -DWITH_CN_LITE=OFF \
            -DWITH_CN_HEAVY=OFF \
            -DWITH_CN_PICO=OFF \
            -DWITH_CN_FEMTO=OFF \
            -DWITH_ARGON2=OFF \
            -DWITH_KAWPOW=OFF \
            -DWITH_GHOSTRIDER=OFF

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Strip binary
        run: |
          strip build/xmrig.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-windows-x64
          path: build/xmrig.exe
